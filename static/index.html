<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Masseur Admin</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            .spinner::after {
                content: "";
                box-sizing: border-box;
                width: 1em;
                height: 1em;
                border: 2px solid currentColor;
                border-right-color: transparent;
                border-radius: 50%;
                display: inline-block;
                animation: spin 0.75s linear infinite;
                margin-left: 0.5rem;
                vertical-align: middle;
            }
            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            /* Fade-in animation for cards */
            .fade-in {
                opacity: 0;
                transform: translateY(10px);
                transition: opacity 0.5s ease, transform 0.5s ease;
            }
            .fade-in.loaded {
                opacity: 1;
                transform: translateY(0);
            }

            .modal-bg {
                background: rgba(0, 0, 0, 0.5);
            }
        </style>
    </head>
    <body
        class="bg-gray-100 text-gray-900 p-4 transition-colors duration-300 dark:bg-gray-900 dark:text-gray-100">
        <header
            class="max-w-3xl mx-auto mb-8 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <!-- Logo Placeholder -->
                <img
                    src="https://mythologian.net/wp-content/uploads/2017/06/Lotus-Flower-Buddhist-Symbol-of-Strength.jpg"
                    alt="Logo"
                    class="w-10 h-10 rounded-full" />
                <h1 class="text-3xl font-bold">Masseur Admin</h1>
            </div>
            <button
                id="themeToggle"
                class="bg-gray-200 text-gray-800 p-2 rounded dark:bg-gray-800 dark:text-gray-100">
                Toggle Dark Mode
            </button>
        </header>

        <main class="max-w-3xl mx-auto space-y-8">
            <!-- Filter & Sort Section -->
            <section>
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">
                        Filter & Sort Appointments
                        <span
                            id="filterCountBadge"
                            class="bg-blue-500 text-white text-sm rounded-full px-2 py-0.5 ml-2 hidden"></span>
                    </h2>
                    <div class="space-x-2">
                        <!-- Export buttons -->
                        <button
                            id="exportCSV"
                            class="bg-gray-200 text-gray-800 p-2 rounded dark:bg-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            Export CSV
                        </button>
                        <button
                            id="exportJSON"
                            class="bg-gray-200 text-gray-800 p-2 rounded dark:bg-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            Export JSON
                        </button>
                    </div>
                </div>
                <div
                    id="filterSection"
                    class="bg-white dark:bg-gray-800 p-4 rounded shadow space-y-4 relative">
                    <div
                        id="filterLoading"
                        class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 hidden dark:bg-opacity-50 dark:bg-gray-900">
                        <span class="text-gray-700 dark:text-gray-300"
                            >Loading<span class="spinner"></span
                        ></span>
                    </div>
                    <div
                        id="filterStatus"
                        class="text-sm text-red-500 hidden"></div>

                    <div
                        class="flex flex-col md:flex-row md:space-x-2 space-y-2 md:space-y-0">
                        <input
                            id="startDateTime"
                            type="datetime-local"
                            class="border p-2 flex-1 dark:bg-gray-700 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 transition"
                            placeholder="Start Date/Time" />
                        <input
                            id="endDateTime"
                            type="datetime-local"
                            class="border p-2 flex-1 dark:bg-gray-700 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 transition"
                            placeholder="End Date/Time" />
                    </div>
                    <div
                        class="flex flex-col md:flex-row md:space-x-2 space-y-2 md:space-y-0">
                        <input
                            id="customerName"
                            type="text"
                            class="border p-2 flex-1 dark:bg-gray-700 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 transition"
                            placeholder="Search Customer" />
                        <select
                            id="sortField"
                            class="border p-2 flex-1 dark:bg-gray-700 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 transition">
                            <option value="">No Sort</option>
                            <option value="time">By Time</option>
                            <option value="customer_name">
                                By Customer Name
                            </option>
                            <option value="duration">By Duration</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- View Toggle -->
            <section>
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Appointments</h2>
                    <div>
                        <button
                            id="viewListBtn"
                            class="bg-gray-200 text-gray-800 p-2 rounded mr-2 dark:bg-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            List View
                        </button>
                        <button
                            id="viewCalendarBtn"
                            class="bg-gray-200 text-gray-800 p-2 rounded dark:bg-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            Calendar View
                        </button>
                    </div>
                </div>

                <!-- List View -->
                <ul id="appointmentsList" class="grid gap-4 md:grid-cols-2">
                    <!-- Appointments injected here -->
                </ul>

                <!-- Calendar View -->
                <div id="calendarView" class="hidden overflow-x-auto">
                    <!-- Simple weekly calendar: Monday-Sunday, 8 AM - 8 PM -->
                    <table class="w-full text-center border-collapse">
                        <thead>
                            <tr class="border-b dark:border-gray-700">
                                <th class="p-2 border-r dark:border-gray-700">
                                    Time
                                </th>
                                <th class="p-2 border-r dark:border-gray-700">
                                    Mon
                                </th>
                                <th class="p-2 border-r dark:border-gray-700">
                                    Tue
                                </th>
                                <th class="p-2 border-r dark:border-gray-700">
                                    Wed
                                </th>
                                <th class="p-2 border-r dark:border-gray-700">
                                    Thu
                                </th>
                                <th class="p-2 border-r dark:border-gray-700">
                                    Fri
                                </th>
                                <th class="p-2 border-r dark:border-gray-700">
                                    Sat
                                </th>
                                <th class="p-2">Sun</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody">
                            <!-- We'll generate rows for hours: 8am to 8pm -->
                            <!-- Each cell can hold appointments that fall into that hour slot -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Add New Appointment Section -->
            <section>
                <h2 class="text-xl font-semibold mb-4">Add New Appointment</h2>
                <div
                    class="bg-white dark:bg-gray-800 p-4 rounded shadow relative">
                    <div
                        id="formLoading"
                        class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 hidden dark:bg-gray-900 dark:bg-opacity-75">
                        <span class="text-gray-700 dark:text-gray-300"
                            >Submitting<span class="spinner"></span
                        ></span>
                    </div>
                    <div
                        id="formStatus"
                        class="text-sm text-red-500 hidden mb-2"></div>

                    <form id="appointmentForm" class="space-y-4">
                        <div>
                            <input
                                type="text"
                                name="customer_name"
                                placeholder="Customer Name"
                                class="border p-2 w-full dark:bg-gray-700 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 transition"
                                required />
                            <div
                                class="text-red-500 text-sm hidden"
                                data-error-for="customer_name"></div>
                        </div>
                        <div>
                            <input
                                type="number"
                                name="duration"
                                placeholder="Duration (min)"
                                class="border p-2 w-full dark:bg-gray-700 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 transition"
                                required />
                            <div
                                class="text-red-500 text-sm hidden"
                                data-error-for="duration"></div>
                        </div>
                        <div>
                            <textarea
                                name="notes"
                                placeholder="Notes"
                                class="border p-2 w-full dark:bg-gray-700 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 transition"></textarea>
                            <div
                                class="text-red-500 text-sm hidden"
                                data-error-for="notes"></div>
                        </div>
                        <button
                            type="submit"
                            class="bg-green-500 text-white p-2 rounded hover:bg-green-600 transition">
                            Add Appointment
                        </button>
                    </form>
                </div>
            </section>
        </main>

        <!-- Details and Edit Modal -->
        <div
            id="detailsModal"
            class="fixed inset-0 hidden modal-bg flex items-center justify-center z-50">
            <div
                class="bg-white dark:bg-gray-800 p-4 rounded shadow max-w-md w-full relative">
                <button
                    id="closeDetailsModal"
                    class="absolute top-2 right-2 text-gray-500 dark:text-gray-300">
                    &times;
                </button>
                <h3 class="text-xl font-semibold mb-4">Appointment Details</h3>
                <div class="space-y-2 mb-4">
                    <div>
                        <strong>Customer:</strong>
                        <span id="detailsCustomer"></span>
                    </div>
                    <div>
                        <strong>Duration:</strong>
                        <span id="detailsDuration"></span> minutes
                    </div>
                    <div>
                        <strong>Time:</strong> <span id="detailsTime"></span>
                    </div>
                    <div>
                        <strong>Notes:</strong> <span id="detailsNotes"></span>
                    </div>
                </div>

                <h4 class="text-lg font-semibold mt-6 mb-2">
                    Edit Appointment
                </h4>
                <form id="editAppointmentForm" class="space-y-4">
                    <div>
                        <input
                            type="text"
                            name="customer_name"
                            class="border p-2 w-full dark:bg-gray-700 dark:border-gray-600"
                            required />
                    </div>
                    <div>
                        <input
                            type="number"
                            name="duration"
                            class="border p-2 w-full dark:bg-gray-700 dark:border-gray-600"
                            required />
                    </div>
                    <div>
                        <textarea
                            name="notes"
                            class="border p-2 w-full dark:bg-gray-700 dark:border-gray-600"></textarea>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button
                            type="button"
                            id="deleteBtnInDetails"
                            class="bg-red-500 text-white p-2 rounded">
                            Delete
                        </button>
                        <button
                            type="submit"
                            class="bg-blue-500 text-white p-2 rounded">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Confirm Delete Modal -->
        <div
            id="deleteModal"
            class="fixed inset-0 hidden modal-bg flex items-center justify-center z-50">
            <div
                class="bg-white dark:bg-gray-800 p-4 rounded shadow max-w-sm w-full relative">
                <h3 class="text-xl font-semibold mb-4">Confirm Deletion</h3>
                <p>Are you sure you want to delete this appointment?</p>
                <div class="flex justify-end space-x-2 mt-4">
                    <button
                        id="cancelDelete"
                        class="border border-gray-300 p-2 rounded dark:border-gray-600">
                        Cancel
                    </button>
                    <button
                        id="confirmDelete"
                        class="bg-red-500 text-white p-2 rounded">
                        Delete
                    </button>
                </div>
            </div>
        </div>

        <script>
            let isFetchingAppointments = false;
            let isSubmittingForm = false;
            let currentAppointments = [];
            let currentEditingId = null;
            let currentDeletingId = null;
            let currentView = "list";

            // Load filters from localStorage
            function loadFiltersFromStorage() {
                const savedFilters = JSON.parse(
                    localStorage.getItem("savedFilters") || "{}"
                );
                if (savedFilters.start)
                    document.getElementById("startDateTime").value =
                        savedFilters.start;
                if (savedFilters.end)
                    document.getElementById("endDateTime").value =
                        savedFilters.end;
                if (savedFilters.customer)
                    document.getElementById("customerName").value =
                        savedFilters.customer;
                if (savedFilters.sort)
                    document.getElementById("sortField").value =
                        savedFilters.sort;
            }

            function saveFiltersToStorage() {
                const start = document.getElementById("startDateTime").value;
                const end = document.getElementById("endDateTime").value;
                const customer = document
                    .getElementById("customerName")
                    .value.trim();
                const sort = document.getElementById("sortField").value;

                const filters = { start, end, customer, sort };
                localStorage.setItem("savedFilters", JSON.stringify(filters));
            }

            // Theme toggle
            const themeToggle = document.getElementById("themeToggle");
            themeToggle.addEventListener("click", () => {
                document.documentElement.classList.toggle("dark");
            });

            // Filter events
            document
                .getElementById("startDateTime")
                .addEventListener("change", () => {
                    saveFiltersToStorage();
                    fetchAppointments();
                });
            document
                .getElementById("endDateTime")
                .addEventListener("change", () => {
                    saveFiltersToStorage();
                    fetchAppointments();
                });
            document
                .getElementById("customerName")
                .addEventListener("input", () => {
                    saveFiltersToStorage();
                    fetchAppointments();
                });
            document
                .getElementById("sortField")
                .addEventListener("change", () => {
                    saveFiltersToStorage();
                    fetchAppointments();
                });

            function countActiveFilters() {
                let count = 0;
                const start = document.getElementById("startDateTime").value;
                const end = document.getElementById("endDateTime").value;
                const customer = document
                    .getElementById("customerName")
                    .value.trim();
                const sort = document.getElementById("sortField").value;

                if (start && end) count++;
                if (customer) count++;
                if (sort) count++;
                return count;
            }

            function updateFilterCountBadge() {
                const count = countActiveFilters();
                const badge = document.getElementById("filterCountBadge");
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove("hidden");
                } else {
                    badge.classList.add("hidden");
                }
            }

            async function fetchAppointments() {
                if (isFetchingAppointments) return;
                isFetchingAppointments = true;

                updateFilterCountBadge();
                showFilterLoading(true);
                clearFilterStatus();

                let url = "/appointments";

                const start = document.getElementById("startDateTime").value;
                const end = document.getElementById("endDateTime").value;
                const customer = document
                    .getElementById("customerName")
                    .value.trim();
                const sort = document.getElementById("sortField").value;

                const params = new URLSearchParams();
                if (start && end) {
                    params.set("start", new Date(start).toISOString());
                    params.set("end", new Date(end).toISOString());
                }
                if (customer) params.set("customer", customer);
                if (sort) params.set("sort", sort);

                const query = params.toString();
                if (query) url += "?" + query;

                try {
                    const res = await fetch(url);
                    if (!res.ok) {
                        setFilterStatus(
                            "Failed to fetch appointments. Please try again."
                        );
                        return;
                    }

                    const data = await res.json();
                    currentAppointments = data;
                    renderAppointments(data);
                } catch (err) {
                    setFilterStatus(
                        "Error fetching appointments: " + err.message
                    );
                } finally {
                    showFilterLoading(false);
                    isFetchingAppointments = false;
                }
            }

            function colorClassForAppointment(ap) {
                if (ap.duration < 30) {
                    return "bg-green-200 dark:bg-green-500";
                } else if (ap.duration <= 60) {
                    return "bg-yellow-200 dark:bg-yellow-500";
                } else {
                    return "bg-red-200 dark:bg-red-500";
                }
            }

            function renderAppointments(appointments) {
                renderListView(appointments);
                renderCalendarView(appointments);
            }

            function renderListView(appointments) {
                const list = document.getElementById("appointmentsList");
                list.innerHTML = "";

                if (appointments.length === 0) {
                    list.innerHTML =
                        '<li class="py-2 text-gray-500 col-span-full">No appointments found for these filters.</li>';
                    return;
                }

                appointments.forEach((ap) => {
                    const li = document.createElement("li");
                    li.className = `bg-white dark:bg-gray-800 p-4 shadow rounded relative cursor-pointer fade-in hover:bg-gray-50 dark:hover:bg-gray-700 transition ${colorClassForAppointment(
                        ap
                    )}`;
                    const formattedTime = new Date(ap.time).toLocaleString();
                    li.innerHTML = `
      <h3 class="font-bold text-lg mb-1">${ap.customer_name}</h3>
      <p class="text-gray-700 dark:text-gray-800 mb-1">Duration: ${ap.duration} min</p>
      <p class="text-gray-700 dark:text-gray-800 mb-1">Time: ${formattedTime}</p>
      <p class="text-gray-700 dark:text-gray-800">${ap.notes}</p>
      <div class="flex space-x-2 absolute top-2 right-2">
        <button class="editBtn text-blue-500 hover:text-blue-700" data-id="${ap.id}" title="Edit">✎</button>
        <button class="deleteBtn text-red-500 hover:text-red-700" data-id="${ap.id}" title="Delete">🗑</button>
      </div>
    `;
                    li.addEventListener("click", (e) => {
                        if (e.target.closest("button")) return;
                        openDetailsModal(ap);
                    });

                    li.querySelector(".editBtn").addEventListener(
                        "click",
                        (e) => {
                            e.stopPropagation();
                            openDetailsModal(ap, true);
                        }
                    );

                    li.querySelector(".deleteBtn").addEventListener(
                        "click",
                        (e) => {
                            e.stopPropagation();
                            confirmDelete(ap.id);
                        }
                    );

                    list.appendChild(li);
                });

                requestAnimationFrame(() => {
                    const items = list.querySelectorAll(".fade-in");
                    items.forEach((item) => {
                        item.classList.add("loaded");
                    });
                });
            }

            function renderCalendarView(appointments) {
                const calendarBody = document.getElementById("calendarBody");
                calendarBody.innerHTML = "";

                const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
                const startHour = 8;
                const endHour = 20;

                for (let hour = startHour; hour <= endHour; hour++) {
                    const row = document.createElement("tr");
                    row.className = "border-b dark:border-gray-700";
                    const timeCell = document.createElement("td");
                    timeCell.className =
                        "p-2 border-r dark:border-gray-700 text-gray-700 dark:text-gray-300";
                    timeCell.textContent = hour + ":00";
                    row.appendChild(timeCell);

                    for (let d = 0; d < 7; d++) {
                        const cell = document.createElement("td");
                        cell.className =
                            "p-2 border-r last:border-r-0 dark:border-gray-700 align-top h-20 relative";
                        cell.style.verticalAlign = "top";
                        row.appendChild(cell);
                    }
                    calendarBody.appendChild(row);
                }

                appointments.forEach((ap) => {
                    const apTime = new Date(ap.time);
                    const dayOfWeek = apTime.getDay();
                    const tableDay = (dayOfWeek + 6) % 7;

                    const hour = apTime.getHours();
                    if (hour < 8 || hour > 20) return;

                    const rowIndex = hour - 8;
                    const row = calendarBody.children[rowIndex];
                    if (!row) return;
                    const cell = row.children[tableDay + 1];
                    if (!cell) return;

                    const apDiv = document.createElement("div");
                    apDiv.className = `mb-1 p-1 text-sm rounded cursor-pointer ${colorClassForAppointment(
                        ap
                    )} hover:opacity-80 transition`;
                    apDiv.innerHTML = `<strong>${ap.customer_name}</strong><br>${ap.duration} min`;
                    apDiv.addEventListener("click", () => {
                        openDetailsModal(ap);
                    });
                    cell.appendChild(apDiv);
                });
            }

            // View toggle
            const appointmentsList =
                document.getElementById("appointmentsList");
            const calendarView = document.getElementById("calendarView");
            const viewListBtn = document.getElementById("viewListBtn");
            const viewCalendarBtn = document.getElementById("viewCalendarBtn");

            viewListBtn.addEventListener("click", () => {
                currentView = "list";
                appointmentsList.classList.remove("hidden");
                calendarView.classList.add("hidden");
            });

            viewCalendarBtn.addEventListener("click", () => {
                currentView = "calendar";
                appointmentsList.classList.add("hidden");
                calendarView.classList.remove("hidden");
            });

            // Modals & Editing
            const detailsModal = document.getElementById("detailsModal");
            const closeDetailsModalBtn =
                document.getElementById("closeDetailsModal");
            closeDetailsModalBtn.addEventListener("click", () => {
                detailsModal.classList.add("hidden");
                currentEditingId = null;
            });

            function openDetailsModal(ap) {
                document.getElementById("detailsCustomer").textContent =
                    ap.customer_name;
                document.getElementById("detailsDuration").textContent =
                    ap.duration;
                document.getElementById("detailsTime").textContent = new Date(
                    ap.time
                ).toLocaleString();
                document.getElementById("detailsNotes").textContent = ap.notes;

                // Pre-fill edit form
                const editForm = document.getElementById("editAppointmentForm");
                editForm.customer_name.value = ap.customer_name;
                editForm.duration.value = ap.duration;
                editForm.notes.value = ap.notes;
                currentEditingId = ap.id;

                detailsModal.classList.remove("hidden");
            }

            // Edit submit
            document
                .getElementById("editAppointmentForm")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();
                    if (!currentEditingId) return;

                    const formData = new FormData(e.target);
                    const payload = {
                        customer_name: formData.get("customer_name").trim(),
                        duration: parseInt(formData.get("duration"), 10),
                        notes: formData.get("notes").trim(),
                    };

                    const res = await fetch(
                        "/appointments/" + currentEditingId,
                        {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(payload),
                        }
                    );

                    if (!res.ok) {
                        alert("Failed to update appointment.");
                        return;
                    }

                    alert("Appointment updated successfully!");
                    detailsModal.classList.add("hidden");
                    currentEditingId = null;
                    fetchAppointments();
                });

            // Delete confirmation
            const deleteModal = document.getElementById("deleteModal");
            const cancelDeleteBtn = document.getElementById("cancelDelete");
            const confirmDeleteBtn = document.getElementById("confirmDelete");
            const deleteBtnInDetails =
                document.getElementById("deleteBtnInDetails");

            deleteBtnInDetails.addEventListener("click", () => {
                if (!currentEditingId) return;
                confirmDelete(currentEditingId);
            });

            cancelDeleteBtn.addEventListener("click", () => {
                deleteModal.classList.add("hidden");
                currentDeletingId = null;
            });

            confirmDeleteBtn.addEventListener("click", async () => {
                if (!currentDeletingId) return;

                const res = await fetch("/appointments/" + currentDeletingId, {
                    method: "DELETE",
                });

                if (!res.ok) {
                    alert("Failed to delete appointment.");
                } else {
                    alert("Appointment deleted successfully!");
                }

                deleteModal.classList.add("hidden");
                currentDeletingId = null;
                detailsModal.classList.add("hidden");
                currentEditingId = null;
                fetchAppointments();
            });

            function confirmDelete(id) {
                currentDeletingId = id;
                deleteModal.classList.remove("hidden");
            }

            // Show/hide loading state for filters
            function showFilterLoading(isLoading) {
                const filterLoading = document.getElementById("filterLoading");
                if (isLoading) {
                    filterLoading.classList.remove("hidden");
                } else {
                    filterLoading.classList.add("hidden");
                }
            }

            function setFilterStatus(msg) {
                const filterStatus = document.getElementById("filterStatus");
                filterStatus.textContent = msg;
                filterStatus.classList.remove("hidden");
            }

            function clearFilterStatus() {
                const filterStatus = document.getElementById("filterStatus");
                filterStatus.textContent = "";
                filterStatus.classList.add("hidden");
            }

            // Appointment form submission
            document
                .getElementById("appointmentForm")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();
                    if (isSubmittingForm) return;

                    const form = e.target;
                    const formData = new FormData(form);

                    clearFormErrors(form);

                    const customerName = formData.get("customer_name").trim();
                    const duration = formData.get("duration").trim();
                    const notes = formData.get("notes").trim();

                    let hasError = false;
                    if (!customerName) {
                        showFieldError(
                            form,
                            "customer_name",
                            "Customer Name is required."
                        );
                        hasError = true;
                    }
                    if (
                        !duration ||
                        isNaN(duration) ||
                        parseInt(duration) <= 0
                    ) {
                        showFieldError(
                            form,
                            "duration",
                            "Duration must be a positive number."
                        );
                        hasError = true;
                    }
                    if (hasError) return;

                    const payload = {
                        customer_name: customerName,
                        duration: parseInt(duration, 10),
                        notes: notes,
                    };

                    try {
                        showFormLoading(true);
                        const res = await fetch("/appointments", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(payload),
                        });

                        if (!res.ok) {
                            setFormStatus(
                                "Failed to create appointment. Please try again."
                            );
                            return;
                        }

                        form.reset();
                        setFormStatus(
                            "Appointment created successfully!",
                            "success"
                        );
                        fetchAppointments();
                    } catch (err) {
                        setFormStatus(
                            "Error creating appointment: " + err.message
                        );
                    } finally {
                        showFormLoading(false);
                    }
                });

            function showFormLoading(isLoading) {
                const formLoading = document.getElementById("formLoading");
                const submitBtn = document.querySelector(
                    '#appointmentForm button[type="submit"]'
                );
                if (isLoading) {
                    formLoading.classList.remove("hidden");
                    submitBtn.disabled = true;
                    isSubmittingForm = true;
                } else {
                    formLoading.classList.add("hidden");
                    submitBtn.disabled = false;
                    isSubmittingForm = false;
                }
            }

            function setFormStatus(msg, type = "error") {
                const formStatus = document.getElementById("formStatus");
                formStatus.textContent = msg;
                formStatus.classList.remove("hidden");
                if (type === "success") {
                    formStatus.classList.remove("text-red-500");
                    formStatus.classList.add("text-green-600");
                } else {
                    formStatus.classList.remove("text-green-600");
                    formStatus.classList.add("text-red-500");
                }
            }

            function clearFormErrors(form) {
                const errorFields = form.querySelectorAll("[data-error-for]");
                errorFields.forEach((el) => {
                    el.classList.add("hidden");
                    el.textContent = "";
                });

                const formStatus = document.getElementById("formStatus");
                formStatus.classList.add("hidden");
                formStatus.textContent = "";
                formStatus.classList.remove("text-green-600");
            }

            function showFieldError(form, fieldName, message) {
                const errorEl = form.querySelector(
                    `[data-error-for="${fieldName}"]`
                );
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.classList.remove("hidden");
                }
            }

            // Export functions
            document
                .getElementById("exportCSV")
                .addEventListener("click", exportCSV);
            document
                .getElementById("exportJSON")
                .addEventListener("click", exportJSON);

            function exportCSV() {
                if (currentAppointments.length === 0) {
                    alert("No appointments to export.");
                    return;
                }
                const headers = [
                    "ID",
                    "Customer Name",
                    "Time",
                    "Duration",
                    "Notes",
                ];
                const rows = currentAppointments.map((ap) => [
                    ap.id,
                    ap.customer_name,
                    new Date(ap.time).toISOString(),
                    ap.duration,
                    (ap.notes || "").replace(/"/g, '""'),
                ]);

                let csv = headers.join(",") + "\n";
                rows.forEach((r) => {
                    csv += r.map((field) => `"${field}"`).join(",") + "\n";
                });

                downloadFile("appointments.csv", csv);
            }

            function exportJSON() {
                if (currentAppointments.length === 0) {
                    alert("No appointments to export.");
                    return;
                }
                const jsonStr = JSON.stringify(currentAppointments, null, 2);
                downloadFile("appointments.json", jsonStr);
            }

            function downloadFile(filename, content) {
                const blob = new Blob([content], { type: "text/plain" });
                const url = URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                a.click();

                URL.revokeObjectURL(url);
            }

            // Initial load
            loadFiltersFromStorage();
            fetchAppointments();
        </script>
    </body>
</html>
